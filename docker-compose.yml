services:
  # =============================================================================
  # DAGSTER SERVICES
  # =============================================================================

  dagster-webserver:
    build:
      context: ./dagster
      dockerfile: Dockerfile
    container_name: lana-dw-webserver
    ports:
      - "3000:3000"
    environment:
      - DAGSTER_HOME=/opt/dagster/home
      # Dagster instance DB (metadata)
      - DAGSTER_PG_HOST=dagster-postgres
      - DAGSTER_PG_PORT=5432
      - DAGSTER_PG_DB=dagster
      - DAGSTER_PG_USER=dagster
      - DAGSTER_PG_PASSWORD=dagster
      # Source lana-bank database
      - LANA_PG_CON=${LANA_PG_CON}
      # Data warehouse target
      - DW_TARGET=${DW_TARGET:-postgres}
      - DW_PG_HOST=${DW_PG_HOST}
      - DW_PG_PORT=${DW_PG_PORT:-5432}
      - DW_PG_DATABASE=${DW_PG_DATABASE}
      - DW_PG_USER=${DW_PG_USER}
      - DW_PG_PASSWORD=${DW_PG_PASSWORD}
      - DW_RAW_SCHEMA=${DW_RAW_SCHEMA:-raw}
      - DW_DBT_SCHEMA=${DW_DBT_SCHEMA:-dbt}
    volumes:
      - ./dagster/dagster.yaml:/opt/dagster/home/dagster.yaml
    command: ["dagster-webserver", "-h", "0.0.0.0", "-p", "3000", "-f", "/lana-dw/src/definitions.py"]
    depends_on:
      dagster-postgres:
        condition: service_healthy
    networks:
      - lana-dw

  dagster-daemon:
    build:
      context: ./dagster
      dockerfile: Dockerfile
    container_name: lana-dw-daemon
    environment:
      - DAGSTER_HOME=/opt/dagster/home
      # Dagster instance DB (metadata)
      - DAGSTER_PG_HOST=dagster-postgres
      - DAGSTER_PG_PORT=5432
      - DAGSTER_PG_DB=dagster
      - DAGSTER_PG_USER=dagster
      - DAGSTER_PG_PASSWORD=dagster
      # Source lana-bank database
      - LANA_PG_CON=${LANA_PG_CON}
      # Data warehouse target
      - DW_TARGET=${DW_TARGET:-postgres}
      - DW_PG_HOST=${DW_PG_HOST}
      - DW_PG_PORT=${DW_PG_PORT:-5432}
      - DW_PG_DATABASE=${DW_PG_DATABASE}
      - DW_PG_USER=${DW_PG_USER}
      - DW_PG_PASSWORD=${DW_PG_PASSWORD}
      - DW_RAW_SCHEMA=${DW_RAW_SCHEMA:-raw}
      - DW_DBT_SCHEMA=${DW_DBT_SCHEMA:-dbt}
    volumes:
      - ./dagster/dagster.yaml:/opt/dagster/home/dagster.yaml
    command: ["dagster-daemon", "run"]
    depends_on:
      dagster-postgres:
        condition: service_healthy
    networks:
      - lana-dw

  # Dagster's internal metadata database (NOT the data warehouse)
  dagster-postgres:
    image: postgres:15
    container_name: lana-dw-dagster-db
    environment:
      - POSTGRES_USER=dagster
      - POSTGRES_PASSWORD=dagster
      - POSTGRES_DB=dagster
    volumes:
      - dagster-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dagster -d dagster"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - lana-dw

  # =============================================================================
  # OPTIONAL: STANDALONE DATA WAREHOUSE DATABASE
  # =============================================================================
  # Uncomment if you want a separate database for the data warehouse.
  # Then set in .env:
  #   DW_PG_HOST=dw-postgres
  #   DW_PG_DATABASE=lana_dw

  # dw-postgres:
  #   image: postgres:15
  #   container_name: lana-dw-postgres
  #   environment:
  #     - POSTGRES_USER=${DW_PG_USER:-postgres}
  #     - POSTGRES_PASSWORD=${DW_POSTGRES_PASSWORD:-dwpassword}
  #     - POSTGRES_DB=${DW_PG_DATABASE:-lana_dw}
  #   volumes:
  #     - dw-postgres-data:/var/lib/postgresql/data
  #   ports:
  #     - "5433:5432"
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${DW_PG_USER:-postgres}"]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - lana-dw

volumes:
  dagster-postgres-data:
  # dw-postgres-data:

networks:
  lana-dw:
    driver: bridge
